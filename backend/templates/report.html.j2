<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Run {{ run_id }} — Evaluation Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    .pass { color: #0F9D58; }
    .fail { color: #DB4437; }
    .card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .header { background: #f8fafc; padding: .5rem .75rem; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: .5rem; border-bottom: 1px solid #e5e7eb; text-align: left; }
    .muted { color: #64748b; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; background: #e5f0ff; color: #1e40af; font-size: .8rem; }
    .metric-failure { padding: 4px 8px; margin: 2px 0; background: #fef2f2; border-left: 3px solid #dc2626; border-radius: 3px; font-size: .9rem; }
    .metric-name { font-weight: 600; color: #991b1b; }
    .reason-text { margin-left: 8px; color: #374151; }
    .output-text { white-space: pre-wrap; font-family: 'Consolas', 'Monaco', monospace; font-size: .9rem; line-height: 1.5; background: #f9fafb; padding: 8px; border-radius: 4px; max-height: 300px; overflow-y: auto; }
    .prompt-text { white-space: pre-wrap; font-family: system-ui; font-size: .95rem; line-height: 1.4; }

    /* Visual donut charts */
    :root { --pass-color: #16a34a; --fail-color: #dc2626; }
    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; align-items: center; }
    .chart-card { display: flex; gap: 1rem; align-items: center; }
    .donut { position: relative; width: 180px; height: 180px; border-radius: 50%;
         background: conic-gradient(var(--pass-color) 0 var(--p), var(--fail-color) var(--p) 100%);
         box-shadow: inset 0 0 0 20px #f3f4f6, 0 2px 6px rgba(0,0,0,.08); }
    .donut::before { content: ""; position: absolute; inset: 40px; border-radius: 50%; background: #ffffff; box-shadow: inset 0 0 0 1px #e5e7eb; }
    .donut::after { content: ""; position: absolute; inset: 0; border-radius: 50%; box-shadow: inset 0 0 0 1px #e5e7eb; opacity: .8; }
    .donut-label { position: absolute; inset: 0; display: grid; place-items: center; font-weight: 600; font-size: 16px; color: #111827; }
    .legend { font-size: .85rem; color: #374151; }
    .legend .dot { display: inline-block; width: 10px; height: 10px; border-radius: 9999px; margin-right: 6px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <div class="header"><h2>Run Summary</h2></div>
    <p><strong>Run ID:</strong> {{ run_id }}</p>
    <p><strong>Dataset:</strong> {{ dataset_id }}</p>
    <p><strong>Model:</strong> {{ model_spec }}</p>
    <p><strong>Input tokens consumed:</strong> {{ input_tokens_total | default(0) }}</p>
    <p><strong>Output tokens consumed:</strong> {{ output_tokens_total | default(0) }}</p>
    {% if domain_description %}
    <p class="muted">{{ domain_description }}</p>
    {% endif %}
  </div>

  {#
    Compute aggregate counts for conversations and turns
  #}
  {% set cns = namespace(total=0, passed=0) %}
  {% for c in conversations %}
    {% set cns.total = cns.total + 1 %}
    {% if c.summary is defined and c.summary and c.summary.conversation_pass is defined and c.summary.conversation_pass %}
      {% set cns.passed = cns.passed + 1 %}
    {% endif %}
  {% endfor %}
  {% set conv_total = cns.total %}
  {% set conv_pass = cns.passed %}
  {% set conv_fail = conv_total - conv_pass %}

  {% set tns = namespace(total=0, passed=0) %}
  {% for c in conversations %}
    {% for t in c.turns %}
      {% set tns.total = tns.total + 1 %}
      {% if t.turn_pass is not defined or t.turn_pass %}
        {% set tns.passed = tns.passed + 1 %}
      {% endif %}
    {% endfor %}
  {% endfor %}
  {% set turn_total = tns.total %}
  {% set turn_pass = tns.passed %}
  {% set turn_fail = turn_total - turn_pass %}

  {% set conv_pass_pct = (100 * conv_pass / conv_total) if conv_total > 0 else 0 %}
  {% set turn_pass_pct = (100 * turn_pass / turn_total) if turn_total > 0 else 0 %}

  <div class="card">
    <div class="header"><h2>Overview</h2></div>
    <div class="charts">
      <div class="chart-card">
        <div class="donut" style="--p: {{ '%.2f'|format(conv_pass_pct) }}%">
          <div class="donut-label">{{ conv_pass }}/{{ conv_total }}</div>
        </div>
        <div>
          <div><strong>Conversations</strong></div>
          <div class="legend"><span class="dot" style="background: var(--pass-color)"></span> Pass: {{ conv_pass }}</div>
          <div class="legend"><span class="dot" style="background: var(--fail-color)"></span> Fail: {{ conv_fail }}</div>
        </div>
      </div>
      <div class="chart-card">
        <div class="donut" style="--p: {{ '%.2f'|format(turn_pass_pct) }}%">
          <div class="donut-label">{{ turn_pass }}/{{ turn_total }}</div>
        </div>
        <div>
          <div><strong>Turns</strong></div>
          <div class="legend"><span class="dot" style="background: var(--pass-color)"></span> Pass: {{ turn_pass }}</div>
          <div class="legend"><span class="dot" style="background: var(--fail-color)"></span> Fail: {{ turn_fail }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="header"><h2>Failure Explanations</h2></div>
    <div class="grid-2">
      <div>
        <h3>Conversation Failures</h3>
        <table>
          <thead>
            <tr><th>Summary</th><th>Failure reason</th></tr>
          </thead>
          <tbody>
          {% for c in conversations %}
            {% set c_pass = c.summary.conversation_pass if c.summary is defined and c.summary and c.summary.conversation_pass is defined else True %}
            {% if not c_pass %}
            <tr>
              <td>
                {% set raw_summary = (c.conversation_description if c.conversation_description is defined and c.conversation_description else (c.scenario if c.scenario is defined else '')) %}
                {% if not raw_summary and c.turns and c.turns[0] and (c.turns[0].user_prompt_snippet is defined) %}
                  {% set raw_summary = c.turns[0].user_prompt_snippet %}
                {% endif %}
                {% set clean = (raw_summary|string) | replace('\n',' ') | replace('\r',' ') %}
                {{ clean | truncate(180) }}
              </td>
              <td>
                {% set outcome = c.summary.final_outcome if c.summary is defined and c.summary.final_outcome is defined else none %}
                {% if outcome and outcome.reasons and outcome.reasons|length > 0 %}
                  <div style="line-height: 1.6;">
                    {% for reason in outcome.reasons %}
                      <div style="margin-bottom: 4px;">• {{ reason }}</div>
                    {% endfor %}
                  </div>
                {% elif c.summary.failed_metrics and (c.summary.failed_metrics|length > 0) %}
                  <div><strong>Failed metrics:</strong> {{ (c.summary.failed_metrics or []) | join(', ') }}</div>
                {% elif c.summary.failed_turns_count is defined and c.summary.failed_turns_count > 0 %}
                  <div class="muted">One or more turns failed. See turn-level details below.</div>
                {% else %}
                  <div class="muted">See detailed turn failures below</div>
                {% endif %}
              </td>
            </tr>
            {% endif %}
          {% endfor %}
          {% if conv_fail == 0 %}
            <tr><td colspan="2" class="muted">No conversation-level failures.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
      <div>
        <h3>Turn Failures</h3>
        <table>
          <thead>
            <tr><th>Conversation • Turn</th><th>Turn summary</th><th>Failure reasons</th></tr>
          </thead>
          <tbody>
          {% set fns = namespace(any=false) %}
          {% for c in conversations %}
            {% for t in c.turns %}
              {% if t.turn_pass is defined and not t.turn_pass %}
                {% set fns.any = true %}
                {% set ex = t.metrics.exact if t.metrics is defined and t.metrics.exact is defined else none %}
                {% set se = t.metrics.semantic if t.metrics is defined and t.metrics.semantic is defined else none %}
                {% set co = t.metrics.consistency if t.metrics is defined and t.metrics.consistency is defined else none %}
                {% set ad = t.metrics.adherence if t.metrics is defined and t.metrics.adherence is defined else none %}
                {% set ha = t.metrics.hallucination if t.metrics is defined and t.metrics.hallucination is defined else none %}
                <tr>
                  <td>
                    <div><strong>{{ c.conversation_title or c.conversation_slug or c.conversation_id }}</strong></div>
                    <div class="muted">Turn {{ t.turn_index }}</div>
                  </td>
                  <td>
                    <div><em>User:</em> {{ t.user_prompt_snippet or '' }}</div>
                    {% if t.assistant_output_snippet %}<div class="muted"><em>Assistant:</em> {{ t.assistant_output_snippet }}</div>{% endif %}
                  </td>
                  <td>
                    {% if ex is not none and ex.pass is defined and not ex.pass %}
                      <div class="metric-failure"><span class="metric-name">Exact:</span>{% if ex.reason %}<span class="reason-text">{{ ex.reason }}</span>{% else %}<span class="reason-text">Match differs from expected</span>{% endif %}</div>
                    {% endif %}
                    {% if se is not none and se.pass is defined and not se.pass %}
                      <div class="metric-failure"><span class="metric-name">Semantic:</span>{% if se.reason %}<span class="reason-text">{{ se.reason }}</span>{% elif se.score_max is defined %}<span class="reason-text">Score {{ '%.2f'|format(se.score_max) }} below threshold</span>{% else %}<span class="reason-text">Below similarity threshold</span>{% endif %}</div>
                    {% endif %}
                    {% if co is not none and co.pass is defined and not co.pass %}
                      <div class="metric-failure"><span class="metric-name">Consistency:</span>{% if co.reason %}<span class="reason-text">{{ co.reason }}</span>{% else %}<span class="reason-text">Inconsistent with prior context</span>{% endif %}</div>
                    {% endif %}
                    {% if ad is not none and ad.pass is defined and not ad.pass %}
                      <div class="metric-failure"><span class="metric-name">Adherence:</span>{% if ad.reason %}<span class="reason-text">{{ ad.reason }}</span>{% else %}<span class="reason-text">Policy criteria not met</span>{% endif %}</div>
                    {% endif %}
                    {% if ha is not none and ha.pass is defined and not ha.pass %}
                      <div class="metric-failure"><span class="metric-name">Hallucination:</span>{% if ha.reason %}<span class="reason-text">{{ ha.reason }}</span>{% else %}<span class="reason-text">Possible hallucination detected</span>{% endif %}</div>
                    {% endif %}
                    {% if (ex is none or ex.pass is not defined or ex.pass) and (se is none or se.pass is not defined or se.pass) and (co is none or co.pass is not defined or co.pass) and (ad is none or ad.pass is not defined or ad.pass) and (ha is none or ha.pass is not defined or ha.pass) %}
                      <span class="muted">No specific failures</span>
                    {% endif %}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          {% endfor %}
          {% if not fns.any %}
            <tr><td colspan="3" class="muted">No turn-level failures.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="header"><h2>Detailed Report</h2></div>
  </div>

  {% for conv in conversations %}
  <div class="card">
    <div class="header">
      <h3>
        {{ conv.conversation_title or conv.conversation_slug or conv.conversation_id }}
        — <span class="badge">{{ 'PASS' if conv.summary.conversation_pass else 'FAIL' }}</span>
      </h3>
      <div class="muted">
        {% if conv.domain %}{{ conv.domain }}{% endif %}
        {% if conv.behavior %}{% if conv.domain %} • {% endif %}{{ conv.behavior }}{% endif %}
        {% if conv.scenario %}{% if conv.domain or conv.behavior %} • {% endif %}{{ conv.scenario }}{% endif %}
        {% if conv.conversation_slug %}{% if conv.domain or conv.behavior or conv.scenario %} • {% endif %}<span class="muted">{{ conv.conversation_slug }}</span>{% endif %}
      </div>
      <div class="muted">Weighted pass rate: {{ '%.2f'|format(conv.summary.weighted_pass_rate or 0) }}</div>
      {% if conv.summary.high_severity_violation is defined and conv.summary.high_severity_violation %}
      <div class="muted"><strong>High-severity violations</strong>: {{ (conv.summary.severity_reasons or [])|join('; ') }}</div>
      {% endif %}
      {% if conv.conversation_description %}
      <div class="muted">{{ conv.conversation_description }}</div>
      {% endif %}
      <div class="muted">
        <strong>Failed turns:</strong> 
        {% set has_failures = namespace(value=false) %}
        {% for t in conv.turns %}{% if t.turn_pass is defined and not t.turn_pass %}{% set has_failures.value = true %}{% endif %}{% endfor %}
        {% if has_failures.value %}
          {% for t in conv.turns %}
            {% if t.turn_pass is defined and not t.turn_pass %}{{ t.turn_index }}{% if not loop.last %}, {% endif %}{% endif %}
          {% endfor %}
        {% else %}
          <span style="color: #059669;">None</span>
        {% endif %}
        {% if conv.summary.failed_metrics %}
          · Failed metrics: {{ (conv.summary.failed_metrics or [])|join(', ') }}
        {% endif %}
      </div>
    </div>

    <h4>Turns</h4>
    <table>
      <thead><tr><th>Turn</th><th>User prompt</th><th>Assistant output</th><th>Pass</th></tr></thead>
      <tbody>
      {% for t in conv.turns %}
        <tr>
          <td>{{ t.turn_index }}</td>
          <td>
            <div class="prompt-text">{{ t.user_prompt_full or t.user_prompt_snippet or '' }}</div>
          </td>
          <td>
            {% set a_full = t.assistant_output_full or t.assistant_output_snippet or '' %}
            <div class="output-text">{{ a_full }}</div>
          </td>
          <td class="{{ 'pass' if t.turn_pass is not defined or t.turn_pass else 'fail' }}">{{ 'True' if t.turn_pass is not defined or t.turn_pass else 'False' }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <h4>Per-turn Metrics</h4>
    <table>
      <thead><tr><th>Turn</th><th>Exact</th><th>Semantic</th><th>Consistency</th><th>Adherence</th><th>Hallucination</th></tr></thead>
      <tbody>
      {% for t in conv.turns %}
        <tr>
          <td>{{ t.turn_index }}</td>
          {% set ex = t.metrics.exact if t.metrics is defined and t.metrics.exact is defined else none %}
          {% set se = t.metrics.semantic if t.metrics is defined and t.metrics.semantic is defined else none %}
          {% set co = t.metrics.consistency if t.metrics is defined and t.metrics.consistency is defined else none %}
          {% set ad = t.metrics.adherence if t.metrics is defined and t.metrics.adherence is defined else none %}
          {% set ha = t.metrics.hallucination if t.metrics is defined and t.metrics.hallucination is defined else none %}
          <td class="{{ 'pass' if ex and ex.pass else 'fail' if ex is not none else '' }}">{{ ex.pass if ex else '' }}</td>
          {% if se and se.skipped %}
            <td class="muted" title="{{ se.reason or '' }}">skipped</td>
          {% else %}
            <td class="{{ 'pass' if se and se.pass else 'fail' if se is not none else '' }}">{{ '%.2f'|format(se.score_max) if se and se.score_max is defined else (se.pass if se else '') }}</td>
          {% endif %}
          <td class="{{ 'pass' if co and co.pass else 'fail' if co is not none else '' }}">{{ co.pass if co else '' }}</td>
          <td class="{{ 'pass' if ad and ad.pass else 'fail' if ad is not none else '' }}">{{ ad.pass if ad else '' }}</td>
          <td class="{{ 'pass' if ha and ha.pass else 'fail' if ha is not none else '' }}">{{ ha.pass if ha else '' }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <h4>Final Outcome</h4>
    {% set outcome = conv.summary.final_outcome if conv.summary is defined and conv.summary.final_outcome is defined else None %}
    {% if outcome %}
      <p class="{{ 'pass' if outcome.pass else 'fail' }}">{{ 'PASS' if outcome.pass else 'FAIL' }} — {{ outcome.reasons|join('; ') }}</p>
    {% else %}
      <p class="{{ 'pass' if conv.summary.conversation_pass else 'fail' }}">{{ 'PASS' if conv.summary.conversation_pass else 'FAIL' }}
      {% if conv.summary.failed_metrics %} — Failed metrics: {{ (conv.summary.failed_metrics or [])|join(', ') }}{% endif %}
      </p>
    {% endif %}
  </div>
  {% endfor %}
</body>
</html>
